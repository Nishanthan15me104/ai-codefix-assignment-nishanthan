services:
  # 1. The main application service (FastAPI)
  code-fix-service:
    build:
      context: .
      # Use the main Dockerfile
      dockerfile: Dockerfile
    # This port mapping is for external access (e.g., hitting http://localhost:8000/docs)
    ports:
      - "8000:8000"
    environment:
      # Define environment variables needed by your LLM/RAG service (e.g., API keys)
      # - GEMINI_API_KEY=your_api_key_here
      - LOG_LEVEL=INFO
    restart: unless-stopped
    
    # Define a simple health check to tell the test runner when the service is ready
    # NOTE: Since the model is now downloaded, the default timing should be sufficient.
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/docs"]
      # Default: interval: 30s, timeout: 30s, retries: 3
      
  # 2. A separate service to run the integration tests
  test-runner:
    build: .
    # IMPORTANT FIX: Change the dependency condition to only wait for the container 
    # to be *running*, not necessarily *healthy*. This lets the tests start quickly.
    depends_on:
      - code-fix-service
      
    # Overrides the main CMD to run the test script instead
    command: /app/run_tests.sh
    environment:
      # Ensure tests have access to any necessary environment variables if required
      # - GEMINI_API_KEY=your_api_key_here
      - LOG_LEVEL=INFO
    
    # Removed logging block to use default console logging for simpler debugging