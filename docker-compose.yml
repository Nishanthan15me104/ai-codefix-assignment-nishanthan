version: '3.8'

services:
  # 1. The main application service (FastAPI)
  code-fix-service:
    build:
      context: .
      # Use the main Dockerfile
      dockerfile: Dockerfile
    # This port mapping is for external access (e.g., hitting http://localhost:8000/docs)
    ports:
      - "8000:8000"
    environment:
      # Define environment variables needed by your LLM/RAG service (e.g., API keys)
      # - GEMINI_API_KEY=your_api_key_here
      - LOG_LEVEL=INFO
    restart: unless-stopped
    
    # ðŸ’¥ FIX: Extended health check to wait up to 30 minutes for model download/load
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/docs"]
      interval: 10s       # Check every 10 seconds
      timeout: 10s        # Wait 10 seconds for each check
      retries: 180        # 180 retries * 10 seconds = 1800 seconds (30 minutes)
      start_period: 20s   # Give the application process 20s to start
      
  # 2. A separate service to run the integration tests
  test-runner:
    build: .
    # ðŸ’¥ FIX: Wait until the code-fix-service is reported as 'healthy'
    # The 'healthy' state is only reached after the 30-minute healthcheck succeeds (model loaded).
    depends_on:
      code-fix-service:
        condition: service_healthy
        
    # Overrides the main CMD to run the test script instead
    command: /app/run_tests.sh
    environment:
      # Ensure tests have access to any necessary environment variables if required
      # - GEMINI_API_KEY=your_api_key_here
      - LOG_LEVEL=INFO