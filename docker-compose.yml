version: '3.8'

services:
  # 1. The main application service (FastAPI)
  code-fix-service:
    build:
      context: .
      # Use the main Dockerfile
      dockerfile: Dockerfile
    # This port mapping is for external access (e.g., hitting http://localhost:8000/docs)
    ports:
      - "8000:8000"
    volumes:
      # Volume 1: Map the persistent volume for the vector database
      - vector_db_data:/app/data/vector_db
      # Volume 2: CRITICAL FIX: Map the persistent volume for the LLM model file
      - model_data:/app/models 
    environment:
      # Define environment variables needed by your LLM/RAG service (e.g., API keys)
      # - GEMINI_API_KEY=your_api_key_here
      - LOG_LEVEL=INFO
      # Define the path where the RAG service should look for/store the vector DB
      - VECTOR_DB_PATH=/app/data/vector_db
      # NEW: Define the persistent path for the GGUF model
      - MODEL_DOWNLOAD_PATH=/app/models
    restart: unless-stopped
    
    # ðŸ’¥ FIX: Extended health check to wait up to 30 minutes for model download/load
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/docs"]
      interval: 10s       # Check every 10 seconds
      timeout: 10s        # Wait 10 seconds for each check
      retries: 180        # 180 retries * 10 seconds = 1800 seconds (30 minutes)
      start_period: 20s   # Give the application process 20s to start
      
  # 2. A separate service to run the integration tests
  test-runner:
    build: .
    volumes:
      # Mount the volume so the test runner can access the vector DB artifacts
      - vector_db_data:/app/data/vector_db
      # Map the model data volume (read-only access might be desirable, but standard is fine)
      - model_data:/app/models 
    # ðŸ’¥ FIX: Wait until the code-fix-service is reported as 'healthy'
    depends_on:
      code-fix-service:
        condition: service_healthy
        
    # Overrides the main CMD to run the test script instead
    command: /app/run_tests.sh
    environment:
      - LOG_LEVEL=INFO
      - VECTOR_DB_PATH=/app/data/vector_db # Ensures tests know where to look
      - MODEL_DOWNLOAD_PATH=/app/models # Ensures tests know where to look
      # - GEMINI_API_KEY=your_api_key_here # Uncomment if needed for tests

# Define the volumes for persistent storage
volumes:
  vector_db_data:
  # NEW VOLUME: For the GGUF model file
  model_data: